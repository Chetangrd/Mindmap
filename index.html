<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MindGraph ‚Äî Knowledge Universe</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap');
  :root {
    --bg: #050810; --surface: #0d1117; --border: #1e2a3a;
    --accent: #00f5c4; --accent2: #7c3aed; --accent3: #f59e0b;
    --text: #e2e8f0; --muted: #64748b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: 'Space Mono', monospace; height: 100vh; overflow: hidden; }
  body::before {
    content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: linear-gradient(rgba(0,245,196,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,245,196,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
  }
  #app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100vh; }
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 24px; border-bottom: 1px solid var(--border);
    background: rgba(5,8,16,0.9); backdrop-filter: blur(10px); flex-shrink: 0;
  }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.3rem; }
  .logo span { color: var(--accent); }
  .logo small { font-size: 0.6rem; color: var(--muted); margin-left: 8px; font-weight: 400; font-family: 'Space Mono', monospace; }
  .stats { display: flex; gap: 20px; font-size: 0.7rem; color: var(--muted); }
  .stat { display: flex; flex-direction: column; align-items: center; gap: 2px; }
  .stat strong { color: var(--accent); font-size: 1rem; }
  .firebase-badge { display: flex; align-items: center; gap: 6px; font-size: 0.68rem; color: #f59e0b; background: rgba(245,158,11,0.08); border: 1px solid rgba(245,158,11,0.25); padding: 4px 10px; border-radius: 20px; }
  .firebase-badge .dot { width: 6px; height: 6px; border-radius: 50%; background: #f59e0b; animation: blink 2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
  main { flex: 1; display: flex; overflow: hidden; }
  #sidebar { width: 300px; flex-shrink: 0; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: rgba(13,17,23,0.98); overflow: hidden; }
  .s-sec { padding: 14px; border-bottom: 1px solid var(--border); }
  .s-sec h3 { font-family: 'Syne', sans-serif; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.15em; color: var(--muted); margin-bottom: 10px; }
  textarea { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 0.75rem; padding: 10px; border-radius: 6px; resize: none; line-height: 1.6; outline: none; transition: border-color 0.2s; }
  textarea:focus { border-color: var(--accent); }
  textarea::placeholder { color: var(--muted); }
  .hint { font-size: 0.62rem; color: var(--muted); margin-top: 5px; }
  .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-family: 'Syne', sans-serif; font-weight: 600; font-size: 0.82rem; letter-spacing: 0.05em; transition: all 0.2s; margin-top: 8px; }
  .btn-primary { background: var(--accent); color: var(--bg); }
  .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .btn-primary.loading { opacity: 0.7; cursor: wait; transform: none; }
  .btn-danger { background: transparent; color: #ef444480; border: 1px solid #ef444430; font-size: 0.72rem; }
  .btn-danger:hover { border-color: #ef4444; color: #ef4444; }
  input[type="text"] { width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border); color: var(--text); font-family: 'Space Mono', monospace; font-size: 0.78rem; padding: 8px 12px; border-radius: 6px; outline: none; transition: border-color 0.2s; }
  input[type="text"]:focus { border-color: var(--accent); }
  input[type="text"]::placeholder { color: var(--muted); }
  #node-list { flex: 1; overflow-y: auto; padding: 6px; }
  #node-list::-webkit-scrollbar { width: 3px; }
  #node-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .node-item { display: flex; align-items: center; gap: 8px; padding: 7px 10px; border-radius: 6px; cursor: pointer; transition: all 0.15s; margin-bottom: 2px; font-size: 0.75rem; border-left: 2px solid transparent; }
  .node-item:hover { background: rgba(0,245,196,0.05); }
  .node-item.active { background: rgba(0,245,196,0.08); border-left-color: var(--accent); }
  .node-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .node-label-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .node-type-badge { font-size: 0.6rem; color: var(--muted); text-transform: uppercase; flex-shrink: 0; }
  #graph-area { flex: 1; position: relative; overflow: hidden; }
  #graph-svg { width: 100%; height: 100%; }
  #tooltip { position: absolute; background: rgba(13,17,23,0.97); border: 1px solid var(--accent); border-radius: 8px; padding: 12px 14px; pointer-events: none; opacity: 0; transition: opacity 0.15s; max-width: 240px; font-size: 0.73rem; z-index: 20; box-shadow: 0 0 24px rgba(0,245,196,0.12); }
  #tooltip h4 { font-family: 'Syne', sans-serif; font-size: 0.88rem; margin-bottom: 4px; color: var(--accent); }
  #tooltip p { color: var(--muted); line-height: 1.5; margin-top: 4px; }
  #tooltip .conn { margin-top: 8px; font-size: 0.68rem; color: var(--muted); }
  #status { position: absolute; bottom: 14px; left: 50%; transform: translateX(-50%); background: rgba(13,17,23,0.9); border: 1px solid var(--border); padding: 6px 14px; border-radius: 20px; font-size: 0.7rem; color: var(--muted); backdrop-filter: blur(10px); pointer-events: none; white-space: nowrap; transition: all 0.3s; }
  #status.success { border-color: var(--accent); color: var(--accent); }
  #status.error { border-color: #ef4444; color: #ef4444; }
  #legend { position: absolute; top: 12px; right: 12px; background: rgba(13,17,23,0.92); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; font-size: 0.67rem; backdrop-filter: blur(10px); }
  #legend h4 { color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 8px; font-size: 0.62rem; }
  .leg { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .leg-dot { width: 7px; height: 7px; border-radius: 50%; }
  #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; opacity: 0.35; }
  #empty-state .icon { font-size: 3rem; margin-bottom: 10px; }
  #empty-state p { font-family: 'Syne', sans-serif; font-size: 0.85rem; color: var(--muted); }
  #info-panel { position: absolute; bottom: 44px; right: 12px; background: rgba(13,17,23,0.97); border: 1px solid var(--border); border-radius: 10px; padding: 14px; width: 230px; font-size: 0.73rem; backdrop-filter: blur(10px); display: none; z-index: 10; box-shadow: 0 4px 24px rgba(0,0,0,0.5); }
  #info-panel .close { position: absolute; top: 8px; right: 12px; cursor: pointer; color: var(--muted); font-size: 1.1rem; }
  #info-panel h4 { font-family: 'Syne', sans-serif; font-size: 0.92rem; margin-bottom: 2px; }
  #info-panel .type-tag { font-size: 0.62rem; text-transform: uppercase; margin-bottom: 8px; }
  #info-panel .desc { color: var(--muted); margin-bottom: 10px; line-height: 1.5; font-size: 0.72rem; }
  #info-panel h5 { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--muted); margin-bottom: 6px; }
  #info-panel ul { list-style: none; }
  #info-panel ul li { color: var(--muted); padding: 4px 0; border-bottom: 1px solid var(--border); font-size: 0.72rem; }
  #info-panel ul li:last-child { border-bottom: none; }
  .spinner { display: inline-block; width: 11px; height: 11px; border: 2px solid transparent; border-top-color: var(--bg); border-radius: 50%; animation: spin 0.6s linear infinite; margin-right: 5px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="logo">Mind<span>Graph</span> <small>Firebase Edition</small></div>
    <div class="stats">
      <div class="stat"><strong id="stat-nodes">0</strong>Nodes</div>
      <div class="stat"><strong id="stat-edges">0</strong>Links</div>
      <div class="stat"><strong id="stat-types">0</strong>Types</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <div class="firebase-badge"><div class="dot"></div> Firebase Live</div>
      <button class="btn btn-danger" style="width:auto;margin:0;padding:5px 12px" onclick="clearAll()">Clear All</button>
    </div>
  </header>
  <main>
    <div id="sidebar">
      <div class="s-sec">
        <h3>‚ú¶ Information Add Karo</h3>
        <textarea id="input-text" rows="5" placeholder="Kuch bhi likho...&#10;&#10;'Rahul ka number 9876543210 hai, woh Delhi mein rehta hai aur Google mein kaam karta hai.'"></textarea>
        <p class="hint">Ctrl+Enter se bhi submit kar sakte ho</p>
        <button class="btn btn-primary" id="add-btn" onclick="processText()">‚ö° AI se Add Karo</button>
      </div>
      <div class="s-sec">
        <h3>‚åï Search</h3>
        <input type="text" id="search-input" placeholder="Koi bhi word..." oninput="searchNodes(this.value)">
      </div>
      <div class="s-sec" style="padding-bottom:8px"><h3>‚óà All Nodes</h3></div>
      <div id="node-list"></div>
    </div>
    <div id="graph-area">
      <svg id="graph-svg"></svg>
      <div id="empty-state">
        <div class="icon">üåê</div>
        <p>Koi bhi information add karo</p>
        <p style="font-size:0.7rem;margin-top:6px;color:var(--muted)">Data Firebase mein save hoga</p>
      </div>
      <div id="legend">
        <h4>Node Types</h4>
        <div class="leg"><div class="leg-dot" style="background:#7c3aed"></div>Person</div>
        <div class="leg"><div class="leg-dot" style="background:#f59e0b"></div>Event</div>
        <div class="leg"><div class="leg-dot" style="background:#10b981"></div>Place</div>
        <div class="leg"><div class="leg-dot" style="background:#ef4444"></div>Number</div>
        <div class="leg"><div class="leg-dot" style="background:#3b82f6"></div>Fact</div>
        <div class="leg"><div class="leg-dot" style="background:#00f5c4"></div>Other</div>
      </div>
      <div id="tooltip"></div>
      <div id="status">üî• Firebase se connect ho raha hai...</div>
      <div id="info-panel">
        <span class="close" onclick="document.getElementById('info-panel').style.display='none'">√ó</span>
        <h4 id="info-title"></h4>
        <div class="type-tag" id="info-type"></div>
        <div class="desc" id="info-info"></div>
        <h5>Connections</h5>
        <ul id="info-connections"></ul>
      </div>
    </div>
  </main>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-dZ8Hl8VBk2Nz_Qn5UkrTjbptT3775gg",
  authDomain: "mindmap-all.firebaseapp.com",
  databaseURL: "https://mindmap-all-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mindmap-all",
  storageBucket: "mindmap-all.firebasestorage.app",
  messagingSenderId: "93721281314",
  appId: "1:93721281314:web:0662b83852117f56b09b7b"
};

const fireapp = initializeApp(firebaseConfig);
const db = getDatabase(fireapp);
const graphRef = ref(db, 'mindgraph');

let graphData = { nodes: [], links: [] };
let simulation, linkSel, nodeSel, labelSel, linkLabelSel;
let transform = d3.zoomIdentity;

const typeColors = { person:'#7c3aed', event:'#f59e0b', place:'#10b981', number:'#ef4444', fact:'#3b82f6', other:'#00f5c4' };
const getColor = t => typeColors[t] || typeColors.other;
const getRadius = n => {
  const c = graphData.links.filter(l => (l.source?.id||l.source)===n.id||(l.target?.id||l.target)===n.id).length;
  return Math.max(10, Math.min(28, 10 + c * 3));
};

// Firebase listener - real-time sync
onValue(graphRef, snap => {
  const data = snap.val();
  graphData = data ? {
    nodes: Object.values(data.nodes || {}),
    links: Object.values(data.links || {})
  } : { nodes: [], links: [] };
  render();
  setStatus(`üî• Synced ‚Äî ${graphData.nodes.length} nodes`, 'success');
});

async function saveToFirebase() {
  const nodesObj = {};
  graphData.nodes.forEach(n => { nodesObj[n.id] = { id:n.id, label:n.label, type:n.type, info:n.info||'' }; });
  const linksObj = {};
  graphData.links.forEach((l, i) => {
    const src = l.source?.id||l.source, tgt = l.target?.id||l.target;
    linksObj[`link_${i}_${src}_${tgt}`] = { source:src, target:tgt, label:l.label||'' };
  });
  await set(graphRef, { nodes: nodesObj, links: linksObj });
}

// D3 setup
const svg = d3.select('#graph-svg');
const W = () => document.getElementById('graph-area').clientWidth;
const H = () => document.getElementById('graph-area').clientHeight;

const zoom = d3.zoom().scaleExtent([0.15, 5]).on('zoom', e => { transform = e.transform; container.attr('transform', e.transform); });
svg.call(zoom);
const container = svg.append('g');
const linkGroup = container.append('g');
const nodeGroup = container.append('g');
const labelGroup = container.append('g');

function render() {
  document.getElementById('stat-nodes').textContent = graphData.nodes.length;
  document.getElementById('stat-edges').textContent = graphData.links.length;
  document.getElementById('stat-types').textContent = new Set(graphData.nodes.map(n=>n.type)).size;
  document.getElementById('empty-state').style.display = graphData.nodes.length===0 ? 'flex':'none';

  svg.select('defs').remove();
  svg.append('defs').append('marker').attr('id','arrow').attr('viewBox','0 -4 8 8').attr('refX',22).attr('markerWidth',6).attr('markerHeight',6).attr('orient','auto')
    .append('path').attr('d','M0,-4L8,0L0,4').attr('fill','rgba(100,116,139,0.6)');

  linkSel = linkGroup.selectAll('line').data(graphData.links, (_,i)=>i);
  linkSel.exit().remove();
  linkSel = linkSel.enter().append('line').attr('stroke','rgba(100,116,139,0.35)').attr('stroke-width',1.5).attr('marker-end','url(#arrow)').merge(linkSel);

  linkLabelSel = linkGroup.selectAll('text.ll').data(graphData.links, (_,i)=>i);
  linkLabelSel.exit().remove();
  linkLabelSel = linkLabelSel.enter().append('text').attr('class','ll').attr('text-anchor','middle').attr('font-size','7.5px').attr('fill','rgba(100,116,139,0.65)').attr('pointer-events','none').merge(linkLabelSel).text(d=>d.label||'');

  nodeSel = nodeGroup.selectAll('circle.nd').data(graphData.nodes, d=>d.id);
  nodeSel.exit().remove();
  const ne = nodeSel.enter().append('circle').attr('class','nd')
    .attr('fill', d=>getColor(d.type)).attr('fill-opacity',0.85)
    .attr('stroke', d=>getColor(d.type)).attr('stroke-width',2).attr('stroke-opacity',0.4)
    .style('cursor','pointer').style('filter', d=>`drop-shadow(0 0 6px ${getColor(d.type)}55)`)
    .call(d3.drag().on('start',dragStart).on('drag',dragged).on('end',dragEnd))
    .on('mouseover', showTT).on('mousemove', moveTT).on('mouseout', hideTT).on('click', nodeClick);
  nodeSel = ne.merge(nodeSel).attr('r', d=>getRadius(d)).attr('fill', d=>getColor(d.type));

  labelSel = labelGroup.selectAll('text.nl').data(graphData.nodes, d=>d.id);
  labelSel.exit().remove();
  labelSel = labelSel.enter().append('text').attr('class','nl').attr('text-anchor','middle')
    .attr('font-family',"'Space Mono',monospace").attr('font-size','9px').attr('fill','#e2e8f0').attr('pointer-events','none')
    .merge(labelSel).text(d=>d.label.length>14?d.label.slice(0,13)+'‚Ä¶':d.label);

  if (simulation) simulation.stop();
  simulation = d3.forceSimulation(graphData.nodes)
    .force('link', d3.forceLink(graphData.links).id(d=>d.id).distance(120).strength(0.5))
    .force('charge', d3.forceManyBody().strength(-250))
    .force('center', d3.forceCenter(W()/2, H()/2))
    .force('collision', d3.forceCollide(d=>getRadius(d)+10))
    .on('tick', ticked);

  updateNodeList();
}

function ticked() {
  linkSel.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
  linkLabelSel.attr('x',d=>((d.source.x||0)+(d.target.x||0))/2).attr('y',d=>((d.source.y||0)+(d.target.y||0))/2-4);
  nodeSel.attr('cx',d=>d.x).attr('cy',d=>d.y);
  labelSel.attr('x',d=>d.x).attr('y',d=>d.y+getRadius(d)+14);
}

function dragStart(e,d){if(!e.active)simulation.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y;}
function dragged(e,d){d.fx=e.x;d.fy=e.y;}
function dragEnd(e,d){if(!e.active)simulation.alphaTarget(0);d.fx=null;d.fy=null;}

function showTT(event,d) {
  const c = graphData.links.filter(l=>(l.source?.id||l.source)===d.id||(l.target?.id||l.target)===d.id).length;
  const tt = document.getElementById('tooltip');
  tt.innerHTML = `<h4>${d.label}</h4><p style="color:${getColor(d.type)};font-size:0.68rem;margin-bottom:3px">${d.type.toUpperCase()}</p>${d.info?`<p>${d.info}</p>`:''}<div class="conn">üîó ${c} connections</div>`;
  tt.style.opacity='1'; moveTT(event);
}
function moveTT(event) {
  const tt=document.getElementById('tooltip');
  const r=document.getElementById('graph-area').getBoundingClientRect();
  let x=event.clientX-r.left+14, y=event.clientY-r.top-10;
  if(x+260>r.width) x-=270;
  tt.style.left=x+'px'; tt.style.top=y+'px';
}
function hideTT(){document.getElementById('tooltip').style.opacity='0';}

function nodeClick(event,d) {
  event.stopPropagation();
  const conns = graphData.links.filter(l=>(l.source?.id||l.source)===d.id||(l.target?.id||l.target)===d.id).map(l=>{
    const oid = (l.source?.id||l.source)===d.id?(l.target?.id||l.target):(l.source?.id||l.source);
    const o = graphData.nodes.find(n=>n.id===oid);
    return `<span style="color:${getColor(d.type)}">${l.label||'‚Üí'}</span> ${o?.label||'?'}`;
  });
  document.getElementById('info-title').textContent=d.label;
  document.getElementById('info-type').textContent=d.type.toUpperCase();
  document.getElementById('info-type').style.color=getColor(d.type);
  document.getElementById('info-info').textContent=d.info||'';
  document.getElementById('info-connections').innerHTML=conns.length?conns.map(c=>`<li>${c}</li>`).join(''):`<li style="color:var(--muted)">No connections</li>`;
  document.getElementById('info-panel').style.display='block';

  nodeSel.attr('fill-opacity',n=>{
    const linked=graphData.links.some(l=>((l.source?.id||l.source)===d.id&&(l.target?.id||l.target)===n.id)||((l.target?.id||l.target)===d.id&&(l.source?.id||l.source)===n.id)||n.id===d.id);
    return linked?1:0.1;
  });
  linkSel.attr('stroke-opacity',l=>(l.source?.id||l.source)===d.id||(l.target?.id||l.target)===d.id?1:0.04)
         .attr('stroke',l=>(l.source?.id||l.source)===d.id||(l.target?.id||l.target)===d.id?getColor(d.type):'rgba(100,116,139,0.35)');
  document.querySelectorAll('.node-item').forEach(el=>el.classList.toggle('active',el.dataset.id===d.id));
}

svg.on('click',()=>{
  nodeSel?.attr('fill-opacity',0.85);
  linkSel?.attr('stroke-opacity',0.35).attr('stroke','rgba(100,116,139,0.35)');
  document.querySelectorAll('.node-item').forEach(el=>el.classList.remove('active'));
});

function updateNodeList() {
  document.getElementById('node-list').innerHTML = graphData.nodes.map(n=>`
    <div class="node-item" data-id="${n.id}" data-label="${n.label}" data-type="${n.type}" onclick="focusNode('${n.id}')">
      <div class="node-dot" style="background:${getColor(n.type)}"></div>
      <span class="node-label-text">${n.label}</span>
      <span class="node-type-badge">${n.type}</span>
    </div>`).join('');
}

function setStatus(msg,type){
  const el=document.getElementById('status');
  el.textContent=msg; el.className=type;
  if(type==='success') setTimeout(()=>{el.className='';el.textContent='Graph ready';},3000);
}

// Exposed globals
window.searchNodes = q => {
  q=q.toLowerCase();
  document.querySelectorAll('.node-item').forEach(el=>{ el.style.display=(!q||el.dataset.label.toLowerCase().includes(q)||el.dataset.type.includes(q))?'':'none'; });
  if(nodeSel) nodeSel.attr('fill-opacity',d=>!q||d.label.toLowerCase().includes(q)||d.type.includes(q)?1:0.1);
};

window.focusNode = id => {
  const node = graphData.nodes.find(n=>n.id===id);
  if(!node) return;
  if(node.x&&node.y){
    const s=transform.k;
    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity.translate(W()/2-node.x*s, H()/2-node.y*s).scale(s));
  }
  nodeClick({stopPropagation:()=>{}}, node);
};

window.clearAll = async () => {
  if(!confirm('Sab kuch delete karna chahte ho? Firebase se bhi remove ho jayega!')) return;
  await remove(graphRef);
  document.getElementById('info-panel').style.display='none';
  setStatus('Graph clear ho gaya','');
};

window.processText = async () => {
  const text = document.getElementById('input-text').value.trim();
  if(!text) return;
  const btn = document.getElementById('add-btn');
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span>AI process kar raha hai...';
  setStatus('AI data extract kar raha hai...','');

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        messages:[{role:'user',content:`Extract entities and relationships from this text as JSON. Return ONLY valid JSON, no markdown, no backticks, no explanation.

Text: "${text}"

Existing node IDs to avoid duplicating: ${JSON.stringify(graphData.nodes.map(n=>n.id))}

Return ONLY this JSON:
{"nodes":[{"id":"snake_case_id","label":"Entity Name","type":"person|place|event|number|fact|other","info":"brief context"}],"links":[{"source":"id1","target":"id2","label":"relationship"}]}

Rules:
- id must be unique snake_case
- Extract: people, places, phone numbers, dates, events, organizations, facts
- type: person, place, event, number, fact, or other
- Build logical relationships
- Skip IDs already in existing list
- Minimum 2 nodes`}]
      })
    });
    const data = await res.json();
    const raw = data.content?.map(b=>b.text||'').join('').replace(/```json|```/g,'').trim();
    const extracted = JSON.parse(raw);

    let added=0;
    extracted.nodes?.forEach(n=>{ if(!graphData.nodes.find(e=>e.id===n.id)){graphData.nodes.push(n);added++;} });
    extracted.links?.forEach(l=>{ const exists=graphData.links.find(e=>(e.source?.id||e.source)===l.source&&(e.target?.id||e.target)===l.target); if(!exists) graphData.links.push(l); });

    await saveToFirebase();
    document.getElementById('input-text').value='';
    setStatus(`‚úì ${added} naye nodes Firebase mein save hue!`,'success');
  } catch(err) {
    console.error(err);
    setStatus('Error! Dobara try karo.','error');
  }
  btn.classList.remove('loading');
  btn.innerHTML='‚ö° AI se Add Karo';
};

document.getElementById('input-text').addEventListener('keydown', e=>{ if(e.ctrlKey&&e.key==='Enter') window.processText(); });
window.addEventListener('resize',()=>simulation?.force('center',d3.forceCenter(W()/2,H()/2)).restart());
</script>
</body>
</html>
